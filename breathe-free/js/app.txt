let data = getData();
let chart;
let cravingInterval;
highRiskHour: 21

function toggleTheme() {
  data.dark = !data.dark;
  saveData(data);
  applyTheme();
}

function applyTheme() {
  document.body.classList.toggle("dark", data.dark);
}

function logSmoke() {
  data.smokedToday++;

  data.smokeEvents.push({
    id: Date.now(),               // unique
    day: data.day,
    timestamp: new Date().toISOString()
  });

  saveData(data);
  render();
}

function renderHourlyHeatmap() {
  const el = document.getElementById("hourlyHeatmap");
  if (!el) return;

  el.innerHTML = "";

  const stats = hourlyStats(data.smokeEvents, data.day);

  stats.forEach((count, hour) => {
    const cell = document.createElement("div");
    cell.className = "hour-cell";
    cell.textContent = hour;

    cell.style.background =
      count === 0 ? "#3bb6a4" :
      count < 2 ? "#e9a23b" :
      "#d64545";

    el.appendChild(cell);
  });
}

function undoSmoke() {
  if (data.smokedToday > 0) {
    data.smokedToday--;
    data.smokeEvents.pop();
    saveData(data);
    render();
  }
}

function startCraving() {
  let time = 300;
  clearInterval(cravingInterval);
  cravingInterval = setInterval(() => {
    document.getElementById("timer").innerText =
      `Craving: ${Math.floor(time/60)}:${String(time%60).padStart(2,"0")}`;
    if (--time < 0) clearInterval(cravingInterval);
  }, 1000);
}

function exportToGoogle() {
  const lastId = data.lastUploadedEventId || 0;
  const newEvents = data.smokeEvents.filter(e => e.id > lastId);

  if (newEvents.length === 0) {
    alert("ℹ️ No new data to upload");
    return;
  }

  fetch("https://script.google.com/macros/s/AKfycbxbVIYvlPEoPAeNMMsAfTObgTgxh76YPK-TRpwFundMSktc3yACdrNtynQ8e_9ydrzR/exec", {
    method: "POST",
    body: JSON.stringify({
      day: data.day,
      baseline: data.baseline,
      smokedToday: data.smokedToday,
      summaries: data.summaries,
      smokeEvents: newEvents
    })
  })
  .then(res => res.text())
  .then(text => {
    if (text === "OK") {
      data.lastUploadedEventId = newEvents[newEvents.length - 1].id;
      saveData(data);
      alert("✅ Backup successful");
    } else {
      alert("❌ Backup failed: " + text);
    }
  })
  .catch(() => alert("❌ Network error"));
}


function nextDay() {
  data.history.push({ day: data.day, count: data.smokedToday });
  data.summaries[data.day] = dailySummary(data);
  data.day++;
  data.smokedToday = 0;
  saveData(data);
  render();
}

function prevDay() {
  if (data.day > 1) data.day--;
  render();
}

function renderChart() {
  const ctx = document.getElementById("progressChart");
  if (!ctx) return;

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.history.map(d => `Day ${d.day}`),
      datasets: [{
        label: "Cigarettes",
        data: data.history.map(d => d.count),
        tension: 0.4
      }]
    }
  });
}

function renderHeatmap() {
  const map = document.getElementById("heatmap");
  map.innerHTML = "";

  data.history.slice(-7).forEach(d => {
    const div = document.createElement("div");
    div.className = "heat";
    div.style.background =
      d.count === 0 ? "#3bb6a4" :
      d.count < 3 ? "#e9a23b" : "#d64545";
    map.appendChild(div);
  });
}

function render() {
  applyTheme();

  document.getElementById("dayText").innerText = `Day ${data.day}`;
  document.getElementById("phaseText").innerText = getPhase(data.day);
  document.getElementById("limitText").innerText =
    `Daily limit: ${dailyLimit(data.baseline, data.day)}`;
  document.getElementById("count").innerText = data.smokedToday;

  document.getElementById("aiInsights").innerHTML =
    generateInsights(data).map(i => `<li>${i}</li>`).join("");

  document.getElementById("dailySummary").innerText =
    data.summaries[data.day] || "";

  renderChart();
  renderHeatmap();
  renderHourlyHeatmap();
  notifyHighRisk(data);
}

function renderTimeline() {
  const el = document.getElementById("timeline");
  if (!el) return;

  const phases = [
    { name: "Awareness", from: 1, to: 7 },
    { name: "Reduction", from: 8, to: 14 },
    { name: "Quit", from: 15, to: 21 },
    { name: "Identity", from: 22, to: 30 }
  ];

  el.innerHTML = "";

  phases.forEach(p => {
    const div = document.createElement("div");
    div.className = "phase";
    if (data.day >= p.from && data.day <= p.to) {
      div.classList.add("active");
    }
    div.innerText = p.name;
    el.appendChild(div);
  });
}

function renderDateTime() {
  const now = new Date();

  const dateEl = document.getElementById("currentDate");
  const timeEl = document.getElementById("currentTime");

  if (!dateEl || !timeEl) return;

  dateEl.innerText = now.toLocaleDateString(undefined, {
    weekday: "short",
    day: "numeric",
    month: "short",
    year: "numeric"
  });

  timeEl.innerText = now.toLocaleTimeString(undefined, {
    hour: "2-digit",
    minute: "2-digit"
  });
}
renderDateTime();
render();

setInterval(renderDateTime, 60000); // update every minute


// ---- Heatmap helpers ----
function getHourlyHeatmapData(selectedDay) {
  const hours = new Array(24).fill(0);

  data.smokeEvents.forEach(ev => {
    if (ev.day !== selectedDay) return;

    const d = new Date(ev.timestamp);
    const hour = d.getHours();

    if (hour >= 0 && hour <= 23) {
      hours[hour]++;
    }
  });

  return hours;
}

